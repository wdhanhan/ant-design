{"version":3,"sources":["components/upload/demo/upload-with-aliyun-oss.tsx?techStack=react"],"sourcesContent":["import '/Users/vagusx/Projects/ant-design/components/upload/demo/upload-with-aliyun-oss.tsx?watch=parent';import React, { useEffect, useState } from 'react';\nimport { UploadOutlined } from '@ant-design/icons';\nimport type { UploadFile, UploadProps } from 'antd';\nimport { Button, Form, message, Upload } from 'antd';\n\ninterface OSSDataType {\n  dir: string;\n  expire: string;\n  host: string;\n  accessId: string;\n  policy: string;\n  signature: string;\n}\n\ninterface AliyunOSSUploadProps {\n  value?: UploadFile[];\n  onChange?: (fileList: UploadFile[]) => void;\n}\n\nconst AliyunOSSUpload = ({ value, onChange }: AliyunOSSUploadProps) => {\n  const [OSSData, setOSSData] = useState<OSSDataType>();\n\n  // Mock get OSS api\n  // https://help.aliyun.com/document_detail/31988.html\n  const mockGetOSSData = () => ({\n    dir: 'user-dir/',\n    expire: '1577811661',\n    host: 'https://660d2bd96ddfa2943b33731c.mockapi.io/api/upload',\n    accessId: 'c2hhb2RhaG9uZw==',\n    policy: 'eGl4aWhhaGFrdWt1ZGFkYQ==',\n    signature: 'ZGFob25nc2hhbw==',\n  });\n\n  const init = async () => {\n    try {\n      const result = await mockGetOSSData();\n      setOSSData(result);\n    } catch (error) {\n      message.error(error as string);\n    }\n  };\n\n  useEffect(() => {\n    init();\n  }, []);\n\n  const handleChange: UploadProps['onChange'] = ({ fileList }) => {\n    console.log('Aliyun OSS:', fileList);\n    onChange?.([...fileList]);\n  };\n\n  const onRemove = (file: UploadFile) => {\n    const files = (value || []).filter((v) => v.url !== file.url);\n\n    if (onChange) {\n      onChange(files);\n    }\n  };\n\n  const getExtraData: UploadProps['data'] = (file) => ({\n    key: file.url,\n    OSSAccessKeyId: OSSData?.accessId,\n    policy: OSSData?.policy,\n    Signature: OSSData?.signature,\n  });\n\n  const beforeUpload: UploadProps['beforeUpload'] = async (file) => {\n    if (!OSSData) return false;\n\n    const expire = Number(OSSData.expire) * 1000;\n\n    if (expire < Date.now()) {\n      await init();\n    }\n\n    const suffix = file.name.slice(file.name.lastIndexOf('.'));\n    const filename = Date.now() + suffix;\n    // @ts-ignore\n    file.url = OSSData.dir + filename;\n\n    return file;\n  };\n\n  const uploadProps: UploadProps = {\n    name: 'file',\n    fileList: value,\n    action: OSSData?.host,\n    onChange: handleChange,\n    onRemove,\n    data: getExtraData,\n    beforeUpload,\n  };\n\n  return (\n    <Upload {...uploadProps}>\n      <Button icon={<UploadOutlined />}>Click to Upload</Button>\n    </Upload>\n  );\n};\n\nconst App: React.FC = () => (\n  <Form labelCol={{ span: 4 }}>\n    <Form.Item label=\"Photos\" name=\"photos\">\n      <AliyunOSSUpload />\n    </Form.Item>\n  </Form>\n);\n\nexport default App;\n"],"names":[],"mappings":"qOA4GA,+CAAA,4BA5GO,oBAA8I,gBACtH,gBAEe,YAgB9C,IAAM,EAAkB,CAAC,CAAE,MAAA,CAAK,CAAE,SAAA,CAAQ,CAAwB,IAChE,GAAM,CAAC,EAAS,EAAW,CAAG,GAAA,UAAQ,IAIhC,EAAiB,IAAO,CAAA,CAC5B,IAAK,YACL,OAAQ,aACR,KAAM,yDACN,SAAU,mBACV,OAAQ,2BACR,UAAW,kBACb,CAAA,EAEM,EAAO,UACX,GAAI,CACF,IAAM,EAAS,MAAM,IACrB,EAAW,GACb,CAAE,MAAO,EAAO,CACd,SAAO,CAAC,KAAK,CAAC,GAChB,CACF,EAEA,GAAA,WAAS,EAAC,KACR,IACF,EAAG,EAAE,EAsBL,IAAM,EAA4C,MAAO,IACvD,GAAI,CAAC,EAAS,MAAO,CAAA,EAErB,IAAM,EAAS,AAAyB,IAAzB,OAAO,EAAQ,MAAM,EAEhC,EAAS,KAAK,GAAG,IACnB,MAAM,IAGR,IAAM,EAAS,EAAK,IAAI,CAAC,KAAK,CAAC,EAAK,IAAI,CAAC,WAAW,CAAC,MAC/C,EAAW,KAAK,GAAG,GAAK,EAI9B,OAFA,EAAK,GAAG,CAAG,EAAQ,GAAG,CAAG,EAElB,EACT,EAEM,EAA2B,CAC/B,KAAM,OACN,SAAU,EACV,MAAM,OAAE,SAAA,EAAS,IAAI,CACrB,SAzC4C,CAAC,CAAE,SAAA,CAAQ,CAAE,IACzD,QAAQ,GAAG,CAAC,cAAe,SAC3B,GAAA,EAAW,IAAI,EAAS,EAC1B,EAuCE,SArCe,AAAC,IAChB,IAAM,EAAQ,AAAC,CAAA,GAAS,EAAE,AAAD,EAAG,MAAM,CAAC,AAAC,GAAM,EAAE,GAAG,GAAK,EAAK,GAAG,EAExD,GACF,EAAS,GAEb,EAgCE,KA9BwC,AAAC,GAAU,CAAA,CACnD,IAAK,EAAK,GAAG,CACb,cAAc,OAAE,SAAA,EAAS,QAAQ,CACjC,MAAM,OAAE,SAAA,EAAS,MAAM,CACvB,SAAS,OAAE,SAAA,EAAS,SAAS,AAC/B,CAAA,EA0BE,aAAA,CACF,EAEA,MACE,UAAC,QAAM,EAAE,GAAG,CAAW,UACrB,UAAC,QAAM,EAAC,KAAM,UAAC,gBAAc,cAAK,sBAGxC,MAUA,EARsB,IACpB,UAAC,MAAI,EAAC,SAAU,CAAE,KAAM,CAAE,WACxB,UAAC,MAAI,CAAC,IAAI,EAAC,MAAM,SAAS,KAAK,kBAC7B,UAAC"}