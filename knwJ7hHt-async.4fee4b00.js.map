{"version":3,"sources":["docs/blog/mock-project-build.zh-CN.md?type=text"],"sourcesContent":["\n  import '/Users/vagusx/Projects/ant-design/docs/blog/mock-project-build.zh-CN.md?watch=parent';\n  export const texts = [{\"value\":\"Ant Design 作为大型组件库，内部依赖十分复杂。有时候 antd 代码本身没有改动，但是底层依赖更新也可能导致开发者的构建失败。比如最近由于我的失误，一处\",\"paraId\":0},{\"value\":\"路径大小写错误\",\"paraId\":0},{\"value\":\"使得在 Linux 下会构建失败。\",\"paraId\":0},{\"value\":\"对于我们自己管理的依赖包，我们定位问题会比较简单。但是对于第三方依赖，往往很难第一时间发现。当用户反馈时，可能已经过了数个小时，使得在几百个包里找不同变得有些困难。我们累积了一些排查经验会与大家分享，但是同时也为了更快解决问题，我们也做了额外的一些事情。\",\"paraId\":1},{\"value\":\"我们为 GitHub issue 添加了一个\",\"paraId\":2,\"tocIndex\":0},{\"value\":\"模板站点\",\"paraId\":2,\"tocIndex\":0},{\"value\":\"，开发者在提交问题时会看到如下表格，会让开发者尽量完整的填写相关信息：\",\"paraId\":2,\"tocIndex\":0},{\"value\":\"通过 antd 版本、React 版本、系统、浏览器版本 信息可以组合出大多数错误问题，帮助尽可能的缩小排查范围。让我们大致确定它是否是一个通用问题或者是一个特定系统的问题。这里我们就不讲组件实现 BUG，单讲讲依赖问题。\",\"paraId\":3,\"tocIndex\":0},{\"value\":\"从 issue 被发现，我们可以通过 github 的 commit CI 倒推出时间范围：\",\"paraId\":4,\"tocIndex\":1},{\"value\":\"接着通过 issue 描述可以确定大致的包和哪些相关（例如 \",\"paraId\":5,\"tocIndex\":1},{\"value\":\"#41236\",\"paraId\":5,\"tocIndex\":1},{\"value\":\" 来自 \",\"paraId\":5,\"tocIndex\":1},{\"value\":\"@rc-component/trigger\",\"paraId\":5,\"tocIndex\":1},{\"value\":\"、\",\"paraId\":5,\"tocIndex\":1},{\"value\":\"#15930\",\"paraId\":5,\"tocIndex\":1},{\"value\":\" 来自 \",\"paraId\":5,\"tocIndex\":1},{\"value\":\"@types/react\",\"paraId\":5,\"tocIndex\":1},{\"value\":\"）。然后通过 npm 查看相关的包的版本发布情况：\",\"paraId\":5,\"tocIndex\":1},{\"value\":\"在确定范围后，我们便可以通过安装先前版本进行构建的方式排查出有问题的版本。暂时在 package.json 中锁定并发布 patch 版本以解决依赖问题（在修复之后解除锁定）。同时也会向对应的 GitHub 提 issue（当然，如果已经有了去 +1 即可）。\",\"paraId\":6,\"tocIndex\":1},{\"value\":\"如你所见，上述的排查方式有一定的滞后性。我们希望通过定时构建的方式减少额外的人力劳动，同时也能让我们更快的发现问题。因而我们复用了 \",\"paraId\":7,\"tocIndex\":2},{\"value\":\"create-next-app-antd\",\"paraId\":7,\"tocIndex\":2},{\"value\":\" 项目作为基底（这样，如果模板项目出了问题，我们同样可以提前发现）。创建了一个每半小时执行一次的 \",\"paraId\":7,\"tocIndex\":2},{\"value\":\"mock-project-build.yml\",\"paraId\":7,\"tocIndex\":2},{\"value\":\" CI，它会定期拉取 \",\"paraId\":7,\"tocIndex\":2},{\"value\":\"create-next-app-antd\",\"paraId\":7,\"tocIndex\":2},{\"value\":\" repo 进行构建：\",\"paraId\":7,\"tocIndex\":2},{\"value\":\"on:\\n  workflow_dispatch:\\n  schedule:\\n    - cron: '*/30 * * * *'\\n\",\"paraId\":8,\"tocIndex\":2},{\"value\":\"通过 \",\"paraId\":9,\"tocIndex\":2},{\"value\":\"--depth=1\",\"paraId\":9,\"tocIndex\":2},{\"value\":\" 只拉取最后一次 commit。再执行 \",\"paraId\":9,\"tocIndex\":2},{\"value\":\"yarn\",\"paraId\":9,\"tocIndex\":2},{\"value\":\" 安装依赖生成对应的 \",\"paraId\":9,\"tocIndex\":2},{\"value\":\"yarn.lock\",\"paraId\":9,\"tocIndex\":2},{\"value\":\" 文件，最后执行 \",\"paraId\":9,\"tocIndex\":2},{\"value\":\"yarn build\",\"paraId\":9,\"tocIndex\":2},{\"value\":\" 进行构建以完全模拟一个项目的构建过程。\",\"paraId\":9,\"tocIndex\":2},{\"value\":\"每次构建成功，CI 都会缓存当下的 \",\"paraId\":10,\"tocIndex\":2},{\"value\":\"yarn.lock\",\"paraId\":10,\"tocIndex\":2},{\"value\":\" 文件。这样，我们在下次构建如果失败了，就可以很方便的拉取两份文件进行对比去排查问题。\",\"paraId\":10,\"tocIndex\":2},{\"value\":\"actions/cache\",\"paraId\":10,\"tocIndex\":2},{\"value\":\" 虽然不允许同名 cache key，但是允许通过 \",\"paraId\":10,\"tocIndex\":2},{\"value\":\"restore-keys\",\"paraId\":10,\"tocIndex\":2},{\"value\":\" 来获取最近的 cache，这就非常方便了：\",\"paraId\":10,\"tocIndex\":2},{\"value\":\"- uses: actions/cache@v4\\n  with:\\n    path: ~tmpProj/yarn.lock\\n    key: primes-${{ runner.os }}-${{ github.run_id }}\\n    restore-keys: mock-proj-lock-file\\n\",\"paraId\":11,\"tocIndex\":2},{\"value\":\"接着监听构建失败事件，对 \",\"paraId\":12,\"tocIndex\":2},{\"value\":\"yarn.lock\",\"paraId\":12,\"tocIndex\":2},{\"value\":\" 文件进行对比快速找出变化的依赖：\",\"paraId\":12,\"tocIndex\":2},{\"value\":\"- name: 🎨 Diff Report\\n  if: ${{ failure() }}\\n  run: npx diff-yarn-lock --source=~tmpProj/yarn.lock --target=~tmpProj/yarn.lock.failed\\n\",\"paraId\":13,\"tocIndex\":2},{\"value\":\"我们在失败时还会通过 IM 推送协议将消息推送到开发者群组，这样我们就可以在第一时间确定问题。完整脚本可以\",\"paraId\":14,\"tocIndex\":2},{\"value\":\"点击此处\",\"paraId\":14,\"tocIndex\":2},{\"value\":\"查看。\",\"paraId\":14,\"tocIndex\":2},{\"value\":\"我们一直在持续优化在维护过程中遇到的问题，如果你在使用中有任何好的想法或者建议，都欢迎在我们的 issue 和 discussion 提出。感谢大家~\",\"paraId\":15,\"tocIndex\":3}];\n  "],"names":[],"mappings":"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"}